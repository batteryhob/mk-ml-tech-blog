---
layout: post
title:  6월리뷰 넛지 초안
date:   1986-12-30 00:00:00 +0900
author: 김도영
tags: python spark
excerpt: 6월리뷰 넛지 초안
toc: true
use_math: false
# tags: 자동 수집되는 태그 띄어쓰기로 구분, 반드시 소문자로 사용
# excerpt: 메인 화면에 노출되는 post의 description
# toc : 목차가 필요 할 경우 true | false
# use_math : 수식이 필요 할 경우(윗 첨자, 아랫첨자 동시 사용 불가) true | false
# emoji 사이트: https://getemoji.com/
---

# 4차 실험 관찰 종료 이후 진행상황 (요약)
- 1~4차 실험 관찰결과
    - 구매액은 증가했으나, 충전액의 변화 없음
    - cashflow EDA 결과 (도영 추가예정 (통계값과 그림))
        - 무료캐시 지급 후 72시간 내에 다수(구매유저 중 60%)의 유저가 무료캐시 사용
        - 무료캐시 사용시 추가 유료충전 빈도는 비교군에서 자연발생하는 유료충전과 같은 빈도를 보임
            - 잔액이 없을 경우, 지급받은 무료캐시로 구매가능한 정도의 아이템을 구매
            - 잔액이 있을 경우, 지급받은 무료캐시와 잔액을 활용하여 아이템을 구매
        - 무료캐시를 사용한 구매를 제외하면 충전 및 구매 양상에 변화 없음
<br/><br/> 
- 과금넛지 1 종료, 과금넛지 2 기획
    - 과금넛지 2
        - 과금넛지 1의 결과 데이터를 활용하여 개인의 충전액 예측 모델 개발, <br/>예측된 충전액과 실제 충전액을 비교하여 이벤트의 효과를 측정
            - 지난 4월 리뷰에서는 단순히 유사한 유저 그룹의 충전액으로 넛지가 없었을 때의 충전액을 추정하려 했으나, 보다 정확한 효과측정을 위해 고도화된 모델링을 적용하기로 결정
        - 개인별 효과측정 결과를 통해 특정 효과가 의심되는 그룹을 특정
        - 해당 그룹과 유사한 유저에게 다음 실험을 적용, 효과 관찰
            - 다음 실헝은 과금넛지 1처럼 단순 지급이 아닌, 개인화 또는 그룹별 메세지를 담은 형태가 되어야 할 것 (단순 지급은 효과가 미미한 것을 확인)
    <br/>
    - 충전액 예측모델 개발
        - 넛징이 없을 때 유저의 과금량을 예측하여 넛징 후 <u><b>유저의 반응 여부를 판단</b></u>하기 위함 
        - [feature 생성 → 모델 fitting → 스코어 확인] 의 과정을 일정 수준 이상의 성능이 나올 때까지 반복
            - 현재 첫번째 루프를 완료하고 두번째 루프 진행중
            <br/><br/>
            - feature 생성
                - 접속, 충전, 구매 관련
                    - 접속횟수, 플레이타임, 미접속일수 등 접속 관련 세부 정보
                    - 구매횟수, 구매액 등 구매 관련 세부 정보
                    - 충전횟수, 충전액 등 충전 관련 세부 정보
                - 인구통계학적 정보
                    - 성별, 나이
                - 아이템 관련
                    - PCA 기반 아이템 그룹 구매 count
                        - (상위 100개 아이템 기준) 유저 아이템 메트릭스를 이용해 PCA로 item 그룹 생성
                    - 유저별 아이템 구매 경험 및 가격
                        - 아이템 평균 가격, 평균 구매 가격, main 아이템 구매 여부 및 수량, 고가치 아이템 구매 여부 및 수량
                - 캐시샵 방문 관련
                    - 과거 방문횟수, 방문일수 등 관련 세부 정보

            - 모델 fitting
                - 목적
                    - 유저별 30일간의 충전량 예측
                - 사용 데이터
                    - 모델링 과정의 데이터는 대조군만을 사용 (넛지에 오염되지 않은 실험대상)
                    - 초반 과금량 분포를 보고, 전체 유저의 10퍼센트 정도의 상위 outlier 제거
                        - outlier로 인해 오차가 커지는 것을 방지
                        - 전반적으로 과소추정하는 모델을 만들기 위함

                - lightGBM
                    - binary 
                        - 약 75만 유저 중 46만이 무과금 유저로, 대부분 0(무과금)으로 예측하는 문제 발생
                        - binary model로 무과금 유저를 걸러낸 후, regression model을 사용하여 오차를 줄이면서 동시에 납득할만한 예측치를 얻고자 함
                        - 보수적인 예측을 위해 label 1 (실제 과금 유저)에 대한 recall (실제 과금 유저를 과금으로 예측하는 것)을 스코어로 사용
                            - 이를 통해, 과금 가능성이 조금이라도 보이는 유저는 걸러지지 않음
                        - label 1에 대한 recall 0.9, 0에 대한 recall 0.5 전후를 보임

                    - regression
                        - MAPE 최소화 LightGBM 회귀 모델
                            - 모델 예측값이 대부분 0인 문제를 보임
                        - MSE 최소화 LightGBM 회귀 모델
                            - 과금이 높은 유저에 대한 오차 패널티를 증대하여, 모델 예측값이 대부분 0인 문제를 완화하려는 시도
                            - MAPE 최소화 LightGBM 회귀 모델에 비해 과금량이 많은 유저에 대한 오차가 상대적으로 작지만, 여전히 대부분 예측값이 0인 문제 잔재
                        - binary 분류 → MAPE & MSE 최소화 LightGBM 회귀 모델
                            - 모델의 예측값이 대부분 0인 문제를 해결하기 위해, binary 분류 모델이 과금 유저라고 예측한 데이터만 사용하여 모델 트레이닝
                            - 분류 모델이 과금 유저라고 예측한 유저의 약 50%는 무과금 유저였고, 예측된 과금량은 여전히 대부분 0으로 예측
                            - 백분률 변환과 log 변환을 시도하였으나 큰 변화 없음

                - KNN
                    - Base model을 위한 KNN
                        - 기존 모델과의 성능 비교를 위한 모델
                    - 과금 여부 예측 이진 분류 LightGBM 모델 → KNN 회귀 모델
                        - 과금 여부 예측 이진 분류 모델이 1(과금 유저)로 예측한 데이터에 한해서 KNN 회귀 모델 적용
                        - 여전히 예측값이 0에 가까운 문제
                        
            - 스코어 확인

              
                | Model                                                        | alias                | MAE     | MAPE (+1000후 계산) |
                | :----------------------------------------------------------- | :------------------- | :------ | :------------------------- |
                | Baseline KNN                                                 | base_knn_model       | 15960원 | 671.80%             |
                | MAPE 최소화 LightGBM 회귀 모델                               | mape_model           | 14694원 | 27.88%              |
                | MSE 최소화 LightGBM 회귀 모델                                | mse_model            | 16035원 | 688.66%             |
                | 과금 여부 예측 이진 분류 LightGBM 모델 → MAPE 최소화 LightGBM 회귀 모델 | bin_mape_model       | 14582원 | 54.01%              |
                | 과금 여부 예측 이진 분류 LightGBM 모델 → MSE 최소화 LightGBM 회귀 모델 | bin_mse_model        | 13799원 | 485.77%             |
                | 과금 여부 예측 이진 분류 LightGBM 모델 → Log 변환 후  MSE 최소화 LightGBM 회귀 모델 | bin_log_mse_model    | 15003원 | 44.52%              |
                | 과금 여부 예측 이진 분류 LightGBM 모델 → 백분률 변환 후 MSE 최소화 LightGBM 회귀 모델 | bin_minmax_mse_model | 13450원 | 469.54%             |
                | 과금 여부 예측 이진 분류 LightGBM 모델 → 백분률 변환 후 MAE 최소화 LightGBM 회귀 모델 | bin_minmax_mae_model | 12056원 | 177.27%             |
                | 과금 여부 예측 이진 분류 LightGBM 모델 → KNN 회귀모델        | bin_knn_model        | 14971원 | 556.93%             |


            ![error1](https://solution-userstats.s3.ap-northeast-1.amazonaws.com/techblogs/yeonsuuu/y_pred_error1.png)


            ![errer2](https://solution-userstats.s3.ap-northeast-1.amazonaws.com/techblogs/yeonsuuu/y_pred_error2.png)


        
        - 첫번째 루프에서의 문제점
            - 문제점 1: cashflow 데이터의 결함
            - 문제점 2: 충분하지 못한 모델 성능
                - 대부분의 값을 0으로 예측, 충전여부를 예측하는 분류모델도 제대로 작동하지 않음
                <br> (모델이 주어진 정보만으로는 타겟을 맞추지 못함)
        - 문제점 해결과정
            - 해결 1: cashflow 데이터의 무결성 확보
            - 해결 2: 두번째 루프 진입
                - 약 1개월 반 가량의 짧은 기간동안 인턴 인원들의 적응 완료, 다음 루프의 진입은 더욱 빠를 것으로 예상됨
                - 모델성능이 부진한 원인 가설 
                    - 모델에 충분한 정보를 주지 않음
                        - 추가 feature 생성
                            - 개별 게임에 종속된 정보
                            - cashflow에서 얻을 수 있는 정보
                            - 시계열 모델 예측결과 및 embedding
                    - 관찰기간인 30일간 발생하는 외부 이벤트가 유저 구매행동에 영향을 줌
                      <br/>(예시 : 이탈, 게임 내 여론 변화, 확률형 아이템의 사용결과 (운) 등)
                        - 모델에 가능한 한 많은 정보를 제공했음에도 스코어가 개선되지 않을 때 의심할 것
                    - 유저의 구매행동이 충동적으로 일어나므로 예측이 불가
                        - 위의 모든 가능성을 다 탐색했음에도 모델 성능이 충분히 나오지 않을 경우, 예측이 불가능한 것으로 간주
<br/><br/>

- 이후 계획
    - 효과측정 도구 개발 
        - 두번째 루프로 진입하여 가설을 검증하고, 개발이 가능한지 확인
    - 새로운 넛지 시나리오 기획
        - 충전액이 늘어나도록 유도하는 넛지
            - 넛징을 받는 유저가 스스로 운이 좋다고 느끼게 하기
            - 넛징으로 캐시 관련 자극을 반복적으로 받도록 설계하기
        - 충전하는 주기가 짧아지도록 유도하는 넛지

<br/>

